<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>2026 Immersive Gallery</title>
    <style>
        * { box-sizing: border-box; }
        html, body { width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; background: #000; position: fixed; }
        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: block; }
        #ui { position: absolute; top: 30px; left: 20px; z-index: 10; pointer-events: none; font-family: sans-serif; transition: opacity 0.3s;}
        .year { font-size: 14vw; font-weight: 900; color: rgba(255,215,0,0.3); margin: 0; line-height: 1; }
        #status { margin-top: 10px; color: #fff; font-size: 11px; padding: 4px 8px; background: rgba(255,255,255,0.1); display: inline-block; }
        video { display: none; }
        /* æ”¾å¤§æ—¶éšè—UI */
        body.zooming #ui { opacity: 0; }
    </style>
</head>
<body>
    <div id="ui"><h1 class="year">2026</h1><div id="status">TAP TO START</div></div>
    <canvas id="c"></canvas>
    <video id="v" playsinline></video>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

    <script>
        const canvas = document.getElementById('c');
        const ctx = canvas.getContext('2d');
        const ui = document.getElementById('ui');
        let w, h, dpr, photos = [];
        let handX = 0, isHandVisible = false, isPinching = false;
        let zoomLerp = 0, currentIdx = 0; 

        function resize() {
            w = window.innerWidth; h = window.innerHeight;
            dpr = Math.min(window.devicePixelRatio || 1, 2); 
            canvas.width = w * dpr; canvas.height = h * dpr;
            ctx.scale(dpr, dpr);
        }

        function animate() {
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, w, h);

            if (photos.length > 0) {
                // æé€Ÿå“åº”çš„å¹³æ»‘ç³»æ•°
                let targetIdx = isHandVisible ? handX * (photos.length - 1) : currentIdx;
                currentIdx += (targetIdx - currentIdx) * 0.35; 
                
                let targetZoom = isPinching ? 1 : 0;
                zoomLerp += (targetZoom - zoomLerp) * 0.3;

                // æ§åˆ¶UIæ˜¾ç¤ºï¼šæ”¾å¤§æ—¶éšè—UI
                if (zoomLerp > 0.1) document.body.classList.add('zooming');
                else document.body.classList.remove('zooming');

                photos.forEach((pData, i) => {
                    let diff = Math.abs(i - currentIdx);
                    // èšç„¦èŒƒå›´æ›´çª„ï¼Œéš”ç¦»æ„Ÿæ›´å¼º
                    let focus = Math.max(0, 1 - diff * 1.5); 
                    
                    ctx.save();

                    // --- æ ¸å¿ƒä¿®æ”¹1ï¼šéš”ç¦»é€»è¾‘ ---
                    // è®¡ç®—åŸºç¡€é€æ˜åº¦
                    let baseAlpha = isHandVisible ? (0.15 + focus * 0.85) : 0.3;
                    // å…³é”®ï¼šå¦‚æœä¸æ˜¯å½“å‰èšç„¦çš„ç…§ç‰‡(focus < 0.8)ï¼Œéšç€æ”¾å¤§åŠ¨ä½œ(zoomLerpå˜å¤§)ï¼Œé€æ˜åº¦è¿…é€Ÿé™ä¸º0
                    if (focus < 0.8) {
                        baseAlpha *= (1 - zoomLerp * 1.2);
                    }
                    ctx.globalAlpha = Math.max(0, baseAlpha);
                    
                    // å¦‚æœé€æ˜åº¦å‡ ä¹ä¸º0ï¼Œç›´æ¥è·³è¿‡ç»˜åˆ¶ï¼ŒèŠ‚çœæ€§èƒ½
                    if (ctx.globalAlpha < 0.01) {
                        ctx.restore();
                        return;
                    }

                    // åŸºç¡€ä½ç½®
                    let bx = 30 + i * 10;
                    let by = 180 + i * 5;
                    
                    // é€‰ä¸­æ—¶çš„ä½ç§»ï¼Œæ”¾å¤§æ—¶ä½ç§»æ›´å¤§ï¼Œç§»åˆ°å±å¹•ä¸­å¿ƒ
                    if (focus > 0) {
                        bx += focus * 40 * (1 - zoomLerp) + (focus * zoomLerp * w * 0.2);
                        by += focus * 15 * (1 - zoomLerp) + (focus * zoomLerp * h * 0.1);
                    }
                    ctx.translate(bx, by);
                    
                    // --- æ ¸å¿ƒä¿®æ”¹2ï¼šå·¨å¹…æ”¾å¤§ ---
                    let baseScale = (w < 600 ? 0.2 : 0.35);
                    // å…³é”®ï¼šå°†æ”¾å¤§å€æ•°ç³»æ•°ä»ä¹‹å‰çš„ 0.6 æå‡åˆ° 3.5ï¼Œå®ç°å·¨å¹…æ”¾å¤§
                    let s = baseScale + (focus * 0.2) + (focus * zoomLerp * 3.5);
                    
                    let iw = pData.img.width * s;
                    let ih = pData.img.height * s;

                    // ç»˜åˆ¶ç…§ç‰‡
                    ctx.drawImage(pData.img, 0, 0, iw, ih);
                    
                    // æ”¾å¤§æ—¶åŠ ä¸€ä¸ªèšç„¦è¾¹æ¡†
                    if (zoomLerp > 0.1 && focus > 0.9) {
                        ctx.strokeStyle = `rgba(255, 215, 0, ${zoomLerp})`;
                        ctx.lineWidth = 3 / s; // ä¿æŒè¾¹æ¡†è§†è§‰å®½åº¦ä¸€è‡´
                        ctx.strokeRect(0, 0, pData.img.width, pData.img.height);
                    }

                    ctx.restore();
                });
            }
            requestAnimationFrame(animate);
        }

        async function init() {
            const hands = new Hands({locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`});
            hands.setOptions({
                maxNumHands: 1, modelComplexity: 0, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5
            });
            
            hands.onResults(res => {
                if (res.multiHandLandmarks && res.multiHandLandmarks[0]) {
                    isHandVisible = true;
                    const lm = res.multiHandLandmarks[0];
                    handX = 1 - lm[9].x; 
                    // æ›´çµæ•çš„æåˆåˆ¤å®š
                    isPinching = Math.hypot(lm[8].x - lm[4].x, lm[8].y - lm[4].y) < 0.05;
                    document.getElementById('status').innerText = isPinching ? "âœ… å·²æ”¾å¤§èšç„¦" : "ğŸ‘‹ å·²è¯†åˆ«æ‰‹æŒ";
                } else {
                    isHandVisible = false;
                    document.getElementById('status').innerText = "ğŸ” å¯»æ‰¾æ‰‹æŒä¸­...";
                }
            });

            const video = document.getElementById('v');
            const cam = new Camera(video, {
                onFrame: async () => { await hands.send({image: video}); },
                width: 320, height: 240
            });

            window.addEventListener('touchstart', () => {
                cam.start();
                document.getElementById('status').innerText = "ğŸ“· ç›¸æœºå¯åŠ¨ä¸­";
            }, {once: true});
        }

        resize();
        window.addEventListener('resize', resize);
        
        let loaded = 0;
        for(let i=1; i<=13; i++) {
            const img = new Image();
            img.crossOrigin = "anonymous";
            img.src = `mj/${i}.jpg`;
            img.onload = () => { if(++loaded === 13) { init(); animate(); } };
        }
    </script>
</body>
</html>
